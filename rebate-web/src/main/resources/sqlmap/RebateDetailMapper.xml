<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="RebateDetail">

    <typeAlias alias="RebateDetail" type="com.rebate.domain.RebateDetail"/>
    <typeAlias alias="RebateDetailQuery" type="com.rebate.domain.query.RebateDetailQuery"/>

    <resultMap class="RebateDetail" id="RebateDetailResultMap">
        <result property="id" column="id"/>
        <result property="orderId" column="order_id"/>
        <result property="productId" column="product_id"/>
        <result property="price" column="price"/>
        <result property="productCount" column="product_count"/>
        <result property="commission" column="commission"/>
        <result property="commissionRatio" column="commission_ratio"/>
        <result property="rebateRatio" column="rebate_ratio"/>
        <result property="submitDate" column="submit_date"/>
        <result property="finishDate" column="finish_date"/>
        <result property="orderStatus" column="order_status"/>
        <result property="status" column="status"/>
        <result property="created" column="created"/>
        <result property="modified" column="modified"/>
        <result property="price" column="price"/>
        <result property="productId" column="product_id"/>
        <result property="productName" column="product_name"/>
        <result property="unionId" column="union_id"/>
        <result property="subUnionId" column="sub_union_id"/>
        <result property="platformRatio" column="platform_ratio"/>
        <result property="userCommission" column="user_commission"/>
        <result property="positionId" column="position_id"/>

    </resultMap>

    <sql id="fields">
        id,
        order_id,
        product_id,
        price,
        product_count,
        commission,
        commission_ratio,
        rebate_ratio,
        submit_date,
        finish_date,
        order_status,
        status,
        price,
        product_id,
        product_name,
        union_id,
        sub_union_id,
        platform_ratio,
        user_commission,
        position_id,
        created,
        modified
    </sql>

    <insert id="insert" parameterClass="RebateDetail">
        insert into  rebate_detail
        (
        order_id,
        product_id,
        product_name,
        price,
        product_count,
        commission,
        commission_ratio,
        rebate_ratio,
        submit_date,
        finish_date,
        order_status,
        status,
        union_id,
        sub_union_id,
        platform_ratio,
        user_commission,
        position_id,
        created,
        modified
        )
        values
        (
        #orderId#,
        #productId#,
        #productName#,
        #price#,
        #productCount#,
        #commission#,
        #commissionRatio#,
        #rebateRatio#,
        #submitDate#,
        #finishDate#,
        #orderStatus#,
        #status#,
        #unionId#,
        #subUnionId#,
        #platformRatio#,
        #userCommission#,
        #positionId#,
        now(),
        now()
        )
        <selectKey resultClass="long" keyProperty="id">
            SELECT @@IDENTITY as id
        </selectKey>
    </insert>

    <sql id="condition">
        <dynamic prepend="where">
            <isNotNull property="orderStatus" prepend=",">
                order_status = #orderStatus#
            </isNotNull>
            <isNotNull property="status" prepend=",">
                status = #status#
            </isNotNull>
            <isNotNull property="orderId" prepend=",">
                order_id=#orderId#
            </isNotNull>
        </dynamic>
    </sql>
    <update id="update">
        update rebate_detail
        set  modified=now()
        <dynamic>
            <isNotNull property="orderStatus" prepend=",">
                order_status = #orderStatus#
            </isNotNull>
            <isNotNull property="status" prepend=",">
                status = #status#
            </isNotNull>
            <isNotNull property="finishDate" prepend=",">
                finish_date = #finishDate#
            </isNotNull>
        </dynamic>
        where order_id=#orderId#
    </update>

    <select id="findCountBySubUnionId" parameterClass="RebateDetailQuery" resultClass="int">
        select
        count(1)
        from rebate_detail
        where sub_union_id=#subUnionId#
    </select>

    <select id="findListBySubUnionId" parameterClass="RebateDetailQuery" resultMap="RebateDetailResultMap">
        select
        <include refid="fields"/>
        from rebate_detail
        where sub_union_id=#subUnionId#
        order by finish_date desc
        limit #startRow#,#pageSize#
    </select>

    <select id="queryRebateDetailByOrderId" parameterClass="RebateDetailQuery" resultMap="RebateDetailResultMap">
        select
        <include refid="fields"/>
        from rebate_detail
        <include refid="condition"/>
        limit 1
    </select>

    <!--用户总返佣金额-->
    <select id="findUserTotalCommission" parameterClass="RebateDetailQuery" resultClass="double">
        select
        sum(user_commission)
        from rebate_detail
        where sub_union_id=#subUnionId# and status=#status#
        limit 1
    </select>
</sqlMap>